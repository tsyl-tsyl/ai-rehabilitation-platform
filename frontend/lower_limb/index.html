<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="rehab_robot_title">åº·å¤æœºå™¨äººæ•°æ®é‡‡é›† - MobileNetV2 åº·å¤è®­ç»ƒç³»ç»Ÿ</title>
    <!-- ä½¿ç”¨æœ¬åœ° Tailwind CSS -->
    <script src="../libs/tailwindcss/tailwindcss.js"></script>
    <!-- ä½¿ç”¨æœ¬åœ° Chart.js -->
    <script src="../libs/chart/chart.js"></script>
    <!-- ä½¿ç”¨æœ¬åœ° Font Awesome -->
    <link rel="stylesheet" href="../libs/font-awesome/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0066CC',
                        secondary: '#1E88E5',
                        accent: '#64B5F6',
                        dark: '#0D47A1',
                        light: '#E3F2FD',
                        deep: '#0A3A7A',
                        med: '#1565C0'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                },
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .card-gradient {
                background: linear-gradient(135deg, #1E88E5 0%, #0D47A1 100%);
            }
            .border-glow {
                box-shadow: 0 0 15px rgba(100, 181, 246, 0.5);
            }
            .fade-in {
                animation: fadeIn 1s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }
    </style>
    
    <style>
        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 6px;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 10px;
            transition: width 0.4s ease;
            width: 50%;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .progress-step {
            text-align: center;
            flex: 1;
            position: relative;
            cursor: pointer;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 5px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .step-active .step-number {
            background: #4facfe;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
        }
        
        .step-label {
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .step-active .step-label {
            opacity: 1;
            font-weight: 600;
        }

        /* ä¸´æ—¶æ¶ˆæ¯æ ·å¼ */
        .temp-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
            animation-fill-mode: forwards;
        }

        .temp-message.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .temp-message.error {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .temp-message.info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        /* æ•°æ®å¯è§†åŒ–å®¹å™¨ */
        .data-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            background: #000;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .data-placeholder {
            text-align: center;
            padding: 20px;
        }

        .data-placeholder i {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        /* å¯è§†åŒ–åŒºåŸŸå¸ƒå±€ */
        .visualization-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .chart-section, .gif-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .chart-section {
            border: 1px solid rgba(100, 181, 246, 0.3);
        }

        .gif-section {
            border: 1px solid rgba(79, 172, 254, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .section-title {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #64B5F6;
        }

        .gif-display {
            width: 100%;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
        }

        .gif-placeholder {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
        }

        .gif-placeholder i {
            font-size: 48px;
            margin-bottom: 10px;
            display: block;
        }

        .action-gif {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
            display: none;
        }

        /* ä»ªè¡¨ç›˜æ ·å¼ */
        .gauge-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .gauge {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .gauge-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .gauge-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }

        .gauge-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            height: 200px;
        }

        /* åŠ¨ä½œæŒ‰é’®æ ·å¼ */
        .action-btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .action-btn:hover::after {
            left: 100%;
        }

        /* åŠ è½½æŒ‡ç¤ºå™¨ */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            outline: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* æ•°æ®è¡¨æ ¼æ ·å¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
        }

        .data-table th,
        .data-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-deep to-med min-h-screen text-white overflow-x-hidden">
    <!-- é¡¶éƒ¨è¿›åº¦æ¡ -->
    <div class="absolute top-0 left-0 right-0 h-1 bg-accent"></div>
    
    <div class="container mx-auto px-4 py-8 relative z-10">
        <!-- å¤´éƒ¨ -->
        <header class="flex justify-between items-center mb-8 fade-in">
            <div class="flex items-center">
                <a href="../index.html" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center mr-3 hover:bg-white/20 transition-colors" title="è¿”å›é¦–é¡µ">
                    <i class="fas fa-home text-xl text-light"></i>
                </a>
                <div class="text-xl font-semibold" data-i18n="system_name">åº·å¤æœºå™¨äººæ•°æ®é‡‡é›†ç³»ç»Ÿ</div>
            </div>
            <div class="flex items-center">
                <div class="text-right mr-4">
                    <div class="text-sm opacity-80" data-i18n="system_description">åŸºäºä¼ æ„Ÿå™¨æ•°æ®çš„ä¸‹è‚¢åº·å¤è®­ç»ƒé‡‡é›†å¹³å°</div>
                </div>
                <!-- è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
                <button id="languageSwitch" class="px-3 py-2 bg-accent hover:bg-accent/80 rounded-lg text-sm transition-all duration-300 flex items-center">
                    <span data-i18n="switchToEnglish">English</span>
                </button>
            </div>
        </header>

        <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
        <div class="max-w-2xl mx-auto mb-8 fade-in">
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-steps">
                <div class="progress-step step-active" onclick="window.location.href='rehab_robot.html'">
                    <div class="step-number">1</div>
                    <div class="step-label" data-i18n="step1_data_collection">æœºå™¨äººæ•°æ®é‡‡é›†</div>
                </div>
                <div class="progress-step" onclick="goToTraining()">
                    <div class="step-number">2</div>
                    <div class="step-label" data-i18n="step2_model_training">æ¨¡å‹è®­ç»ƒ</div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®é‡‡é›†é¢æ¿ -->
        <div class="card-gradient rounded-2xl p-6 shadow-lg border border-accent/30 border-glow fade-in">
            <h2 class="text-2xl font-bold mb-4 text-center" data-i18n="robot_data_collection">ğŸ¤– åº·å¤æœºå™¨äººå®æ—¶æ•°æ®é‡‡é›†</h2>
            
            <!-- æ•°æ®å¯è§†åŒ–åŒºåŸŸ - å¹¶æ’å¸ƒå±€ -->
            <div class="visualization-container">
                <!-- å·¦ä¾§ï¼šåŸæœ‰çš„æ•°æ®å®¹å™¨ -->
                <div class="chart-section">
                    <div class="section-title" data-i18n="robot_status">æœºå™¨äººçŠ¶æ€ç›‘æ§</div>
                    <div class="data-container" id="dataContainer">
                        <div class="data-placeholder" id="dataPlaceholder">
                            <i class="fas fa-robot"></i>
                            <div data-i18n="robot_not_connected">æœºå™¨äººæ•°æ®æœªè¿æ¥</div>
                            <div class="text-sm opacity-80 mt-2" data-i18n="click_to_connect">ç‚¹å‡»"è¿æ¥æœºå™¨äºº"å¼€å§‹é‡‡é›†</div>
                        </div>
                        <canvas id="motionChart" style="display: none; width: 100%; height: 100%;"></canvas>
                    </div>
                </div>
                
                <!-- å³ä¾§ï¼šGIFå±•ç¤ºåŒºåŸŸ -->
                <div class="gif-section">
                    <div class="section-title" data-i18n="exercise_demonstration">åº·å¤æœºå™¨æ¼”ç¤º</div>
                    <div class="gif-display">
                        <div class="gif-placeholder" id="gifPlaceholder">
                            <i class="fas fa-video"></i>
                            <div data-i18n="select_exercise_to_view">é€‰æ‹©è®­ç»ƒåŠ¨ä½œæŸ¥çœ‹æ¼”ç¤º</div>
                        </div>
                        <!-- ä¸åŒåŠ¨ä½œçš„GIF -->
                        <img id="kneeFlexionGif" src="../static/gifs/knee_flexion.gif" class="action-gif" alt="åº·å¤æœºå™¨æ¼”ç¤º">
                        
                    </div>
                    <div class="mt-4 text-center text-sm opacity-70" data-i18n="gif_instruction" style="display:none;">
                        å½“å‰åŠ¨ä½œæ¼”ç¤ºå°†å¸®åŠ©æ‚¨æ­£ç¡®æ‰§è¡Œåº·å¤è®­ç»ƒ
                    </div>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-4 my-6 justify-center">
                <button id="robotConnectBtn" onclick="toggleRobotConnection()" class="btn btn-primary">
                    <i class="fas fa-plug mr-2"></i><span data-i18n="connect_robot">è¿æ¥æœºå™¨äºº</span>
                </button>
                <button id="collectionToggle" onclick="toggleCollection()" disabled class="btn bg-white/10 hover:bg-white/20">
                    <i class="fas fa-record-vinyl mr-2"></i><span data-i18n="start_collection">å¼€å§‹é‡‡é›†</span>
                </button>
                <button id="sendDataBtn" onclick="sendRobotDataToServer()" class="btn btn-secondary">
                    <span id="sendDataText"><i class="fas fa-paper-plane mr-2"></i><span data-i18n="send_data">å‘é€æ•°æ®</span></span>
                    <span id="sendDataLoader" class="loader hidden"></span>
                </button>
            </div>

            <!-- é‡‡é›†çŠ¶æ€å¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white/10 p-4 rounded-lg text-center">
                    <div class="text-sm opacity-80 mb-1" data-i18n="collected_samples">å·²é‡‡é›†æ ·æœ¬</div>
                    <div class="text-2xl font-bold"><span id="collectedSamples">0</span> / <span id="targetSamples">100</span></div>
                </div>
                <div class="bg-white/10 p-4 rounded-lg text-center">
                    <div class="text-sm opacity-80 mb-1" data-i18n="current_action">å½“å‰åŠ¨ä½œ</div>
                    <div class="text-xl font-bold" id="currentAction" data-i18n="not_selected">æœªé€‰æ‹©</div>
                </div>
                <div class="bg-white/10 p-4 rounded-lg text-center">
                    <div class="text-sm opacity-80 mb-1" data-i18n="connection_status">è¿æ¥çŠ¶æ€</div>
                    <div class="text-xl font-bold" id="connectionStatus" data-i18n="not_connected">æœªè¿æ¥</div>
                </div>
                <div class="bg-white/10 p-4 rounded-lg text-center">
                    <div class="text-sm opacity-80 mb-1" data-i18n="data_quality">æ•°æ®è´¨é‡</div>
                    <div class="text-xl font-bold" id="dataQuality">--</div>
                </div>
            </div>

            <!-- åŠ¨ä½œé€‰æ‹© -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-center" data-i18n="select_rehab_exercise">é€‰æ‹©åº·å¤è®­ç»ƒåŠ¨ä½œ</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button id="kneeFlexionBtn" onclick="setAction('knee_flexion_extension', this)" class="action-btn py-3 px-4 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all duration-300" data-i18n="knee_flexion">
                        è†å…³èŠ‚å±ˆä¼¸
                    </button>
                    <button id="hipAbductionBtn" onclick="setAction('hip_abduction_adduction', this)" class="action-btn py-3 px-4 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all duration-300" data-i18n="hip_abduction">
                        é«‹å…³èŠ‚å¤–å±•
                    </button>
                    <button id="ankleDorsiflexionBtn" onclick="setAction('ankle_dorsiflexion', this)" class="action-btn py-3 px-4 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all duration-300" data-i18n="ankle_dorsiflexion">
                        è¸å…³èŠ‚èƒŒå±ˆ
                    </button>
                    <button id="balanceTrainingBtn" onclick="setAction('balance_training', this)" class="action-btn py-3 px-4 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-all duration-300" data-i18n="balance_training">
                        å¹³è¡¡è®­ç»ƒ
                    </button>
                </div>
            </div>

            <!-- å®æ—¶æ•°æ®ä»ªè¡¨ç›˜ -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 text-center" data-i18n="real_time_sensor_data">å®æ—¶ä¼ æ„Ÿå™¨æ•°æ®</h3>
                <div class="gauge-container">
                    <div class="gauge">
                        <div class="text-sm opacity-80" data-i18n="knee_angle">è†å…³èŠ‚è§’åº¦</div>
                        <div class="gauge-value" id="kneeAngle">0Â°</div>
                        <div class="gauge-bar">
                            <div class="gauge-fill bg-green-500" id="kneeAngleBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="gauge">
                        <div class="text-sm opacity-80" data-i18n="resistance_force">é˜»åŠ›å¼ºåº¦</div>
                        <div class="gauge-value" id="resistanceForce">0 N</div>
                        <div class="gauge-bar">
                            <div class="gauge-fill bg-blue-500" id="resistanceForceBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="gauge">
                        <div class="text-sm opacity-80" data-i18n="gait_symmetry">æ­¥æ€å¯¹ç§°æ€§</div>
                        <div class="gauge-value" id="gaitSymmetry">0%</div>
                        <div class="gauge-bar">
                            <div class="gauge-fill bg-yellow-500" id="gaitSymmetryBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="gauge">
                        <div class="text-sm opacity-80" data-i18n="movement_smoothness">è¿åŠ¨å¹³æ»‘åº¦</div>
                        <div class="gauge-value" id="movementSmoothness">0%</div>
                        <div class="gauge-bar">
                            <div class="gauge-fill bg-purple-500" id="movementSmoothnessBar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®é¢„è§ˆ -->
            <div class="bg-white/10 p-4 rounded-lg">
                <h4 class="font-bold mb-3 text-center" data-i18n="real_time_data_stream">å®æ—¶æ•°æ®æµ</h4>
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-i18n="timestamp">æ—¶é—´æˆ³</th>
                                <th data-i18n="knee_angle">è†å…³èŠ‚è§’åº¦</th>
                                <th data-i18n="resistance">é˜»åŠ›(N)</th>
                                <th data-i18n="symmetry">å¯¹ç§°æ€§</th>
                                <th data-i18n="smoothness">å¹³æ»‘åº¦</th>
                                <th data-i18n="rehab_stage">åº·å¤é˜¶æ®µ</th>
                            </tr>
                        </thead>
                        <tbody id="dataStream">
                            <tr>
                                <td colspan="6" class="text-center py-4 opacity-60" data-i18n="waiting_for_data">ç­‰å¾…æ•°æ®é‡‡é›†...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="../static/js/common.js"></script>
    <script src="../static/js/i18nManage.js"></script>
    
    <script>
        // å…¨å±€å˜é‡å£°æ˜
        let isConnected = false;
        let isCollecting = false;
        let collectedSamples = 0;
        const targetSamples = 100;
        let currentAction = '';
        let robotDataBuffer = [];
        let dataInterval = null;
        
        // å›¾è¡¨å®ä¾‹
        let motionChart = null;
        
        // åº·å¤æœºå™¨äººç±»åˆ«ID
        const ROBOT_CATEGORY = 'lower_limb';

        // ========== å›½é™…åŒ–åŠŸèƒ½ ==========
      

        // ========== é¡µé¢è·³è½¬å‡½æ•° ==========
        function goToTraining() {
            window.location.href = `../upper_limb/tranTSF.html?category=${ROBOT_CATEGORY}`;
        }

        // ========== GIFæ˜¾ç¤ºæ§åˆ¶ ==========
        function showActionGif(action) {
            // éšè—æ‰€æœ‰GIF
            document.querySelectorAll('.action-gif').forEach(gif => {
                gif.style.display = 'none';
            });
            
            // éšè—å ä½ç¬¦
            const placeholder = document.getElementById('gifPlaceholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }
            
            // æ˜¾ç¤ºå¯¹åº”çš„GIF
            const gifMap = {
                'knee_flexion_extension': 'kneeFlexionGif',
                'hip_abduction_adduction': 'hipAbductionGif',
                'ankle_dorsiflexion': 'ankleDorsiflexionGif',
                'balance_training': 'balanceTrainingGif'
            };
            
            const gifId = gifMap[action];
            if (gifId) {
                const gifElement = document.getElementById(gifId);
                if (gifElement) {
                    gifElement.style.display = 'block';
                    // é‡æ–°åŠ è½½GIFä»¥ç¡®ä¿åŠ¨ç”»æ’­æ”¾
                    gifElement.src = gifElement.src;
                }
            }
        }

        // ========== æœºå™¨äººè¿æ¥æ§åˆ¶ ==========
        async function toggleRobotConnection() {
            const connectBtn = document.getElementById('robotConnectBtn');
            
            if (!isConnected) {
                await connectToRobot();
            } else {
                disconnectFromRobot();
            }
        }

        async function connectToRobot() {
            try {
                const connectBtn = document.getElementById('robotConnectBtn');
                const collectionBtn = document.getElementById('collectionToggle');
                const statusElement = document.getElementById('connectionStatus');
                const dataPlaceholder = document.getElementById('dataPlaceholder');
                const motionCanvas = document.getElementById('motionChart');
                
                if (connectBtn) {
                    connectBtn.disabled = true;
                    connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>' + i18n.t('connecting');
                }
                
                // æ¨¡æ‹Ÿè¿æ¥å»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                isConnected = true;
                
                // æ›´æ–°UI
                if (connectBtn) {
                    connectBtn.disabled = false;
                    connectBtn.innerHTML = '<i class="fas fa-plug mr-2"></i>' + i18n.t('disconnect');
                    connectBtn.classList.remove('btn-primary');
                    connectBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                }
                
                if (collectionBtn) collectionBtn.disabled = false;
                if (statusElement) {
                    statusElement.textContent = i18n.t('connected');
                    statusElement.className = 'text-xl font-bold text-green-400';
                }
                if (dataPlaceholder) dataPlaceholder.style.display = 'none';
                if (motionCanvas) motionCanvas.style.display = 'block';
                
                // åˆå§‹åŒ–å›¾è¡¨
                initializeCharts();
                
                // å¼€å§‹æ¨¡æ‹Ÿæ•°æ®æµ
                startDataStream();
                
                showTemporaryMessage(i18n.t('robot_connected_success'), 'success');
                
            } catch (error) {
                console.error('è¿æ¥æœºå™¨äººå¤±è´¥:', error);
                showTemporaryMessage(i18n.t('robot_connection_failed'), 'error');
                resetConnectionState();
            }
        }

        function disconnectFromRobot() {
            stopDataStream();
            
            isConnected = false;
            if (isCollecting) {
                stopCollection();
            }
            
            const connectBtn = document.getElementById('robotConnectBtn');
            const collectionBtn = document.getElementById('collectionToggle');
            const statusElement = document.getElementById('connectionStatus');
            const dataPlaceholder = document.getElementById('dataPlaceholder');
            const motionCanvas = document.getElementById('motionChart');
            
            if (connectBtn) {
                connectBtn.innerHTML = '<i class="fas fa-plug mr-2"></i>' + i18n.t('connect_robot');
                connectBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                connectBtn.classList.add('btn-primary');
            }
            
            if (collectionBtn) collectionBtn.disabled = true;
            if (statusElement) {
                statusElement.textContent = i18n.t('not_connected');
                statusElement.className = 'text-xl font-bold text-red-400';
            }
            if (dataPlaceholder) dataPlaceholder.style.display = 'block';
            if (motionCanvas) motionCanvas.style.display = 'none';
            
            showTemporaryMessage(i18n.t('robot_disconnected'), 'info');
        }

        function resetConnectionState() {
            const connectBtn = document.getElementById('robotConnectBtn');
            if (connectBtn) {
                connectBtn.disabled = false;
                connectBtn.innerHTML = '<i class="fas fa-plug mr-2"></i>' + i18n.t('connect_robot');
                connectBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                connectBtn.classList.add('btn-primary');
            }
        }

        // ========== æ•°æ®é‡‡é›†æ§åˆ¶ ==========
        function toggleCollection() {
            if (isCollecting) {
                stopCollection();
            } else {
                startCollection();
            }
        }

        function startCollection() {
            if (!currentAction) {
                showTemporaryMessage(i18n.t('select_exercise_first'), 'error');
                return;
            }
            if (!isConnected) {
                showTemporaryMessage(i18n.t('connect_robot_first'), 'error');
                return;
            }
            
            isCollecting = true;
            collectedSamples = 0;
            robotDataBuffer = [];
            
            const collectionBtn = document.getElementById('collectionToggle');
            if (collectionBtn) {
                collectionBtn.innerHTML = '<i class="fas fa-stop mr-2"></i>' + i18n.t('stop_collection');
                collectionBtn.classList.remove('bg-white/10', 'hover:bg-white/20');
                collectionBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            }
            
            updateSamplesCounter();
            showTemporaryMessage(i18n.t('start_collecting_data', {action: getActionName(currentAction)}), 'success');
        }

        function stopCollection() {
            isCollecting = false;
            
            const collectionBtn = document.getElementById('collectionToggle');
            if (collectionBtn) {
                collectionBtn.innerHTML = '<i class="fas fa-record-vinyl mr-2"></i>' + i18n.t('start_collection');
                collectionBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                collectionBtn.classList.add('bg-white/10', 'hover:bg-white/20');
            }
            
            showTemporaryMessage(i18n.t('collection_stopped', {samples: collectedSamples}), 'info');
        }

        // ========== æ•°æ®æµæ¨¡æ‹Ÿ ==========
        function startDataStream() {
            // æ¸…é™¤ä¹‹å‰çš„é—´éš”
            if (dataInterval) {
                clearInterval(dataInterval);
            }
            
            // æ¯ç§’ç”Ÿæˆ10ä¸ªæ•°æ®ç‚¹ï¼ˆ100Hzæ¨¡æ‹Ÿï¼‰
            dataInterval = setInterval(generateRobotData, 100);
        }

        function stopDataStream() {
            if (dataInterval) {
                clearInterval(dataInterval);
                dataInterval = null;
            }
        }

        function generateRobotData() {
            if (!isConnected) return;
            
            const timestamp = new Date().toLocaleTimeString();
            
            // æ ¹æ®å½“å‰åŠ¨ä½œç”Ÿæˆç›¸åº”çš„æ•°æ®æ¨¡å¼
            let baseAngle, angleRange, baseForce, forceRange;
            
            switch(currentAction) {
                case 'knee_flexion_extension':
                    baseAngle = 60;
                    angleRange = 60;
                    baseForce = 25;
                    forceRange = 20;
                    break;
                case 'hip_abduction_adduction':
                    baseAngle = 30;
                    angleRange = 40;
                    baseForce = 15;
                    forceRange = 15;
                    break;
                case 'ankle_dorsiflexion':
                    baseAngle = 10;
                    angleRange = 30;
                    baseForce = 10;
                    forceRange = 10;
                    break;
                case 'balance_training':
                    baseAngle = 5;
                    angleRange = 10;
                    baseForce = 5;
                    forceRange = 5;
                    break;
                default:
                    baseAngle = 45;
                    angleRange = 45;
                    baseForce = 20;
                    forceRange = 15;
            }
            
            // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®ï¼ˆå¸¦æ­£å¼¦æ³¢åŠ¨ï¼‰
            const time = Date.now() / 1000;
            const kneeAngle = baseAngle + Math.sin(time * 2) * angleRange / 2;
            const resistanceForce = baseForce + Math.sin(time * 1.5) * forceRange / 2;
            const gaitSymmetry = 80 + Math.sin(time) * 15; // 65-95%
            const movementSmoothness = 85 + Math.cos(time * 0.8) * 10; // 75-95%
            
            // ä¼°è®¡åº·å¤é˜¶æ®µ
            const rehabStage = estimateRehabStage(kneeAngle, resistanceForce);
            
            // åˆ›å»ºæ•°æ®åŒ…
            const dataPacket = {
                timestamp: timestamp,
                knee_angle: Math.round(kneeAngle * 10) / 10,
                resistance_force: Math.round(resistanceForce * 10) / 10,
                gait_symmetry: Math.round(gaitSymmetry * 10) / 10,
                movement_smoothness: Math.round(movementSmoothness * 10) / 10,
                rehab_stage: rehabStage,
                exercise_type: currentAction
            };
            
            // æ›´æ–°å®æ—¶æ˜¾ç¤º
            updateRealTimeDisplay(dataPacket);
            
            // å¦‚æœæ­£åœ¨é‡‡é›†ï¼Œä¿å­˜æ•°æ®
            if (isCollecting && currentAction) {
                saveRobotData(dataPacket);
            }
            
            // æ›´æ–°å›¾è¡¨æ•°æ®
            updateCharts(dataPacket);
        }

        function estimateRehabStage(angle, force) {
            if (angle < 60 && force < 15) return 'initial';
            if (angle < 90 && force < 30) return 'mid';
            return 'advanced';
        }

        function saveRobotData(dataPacket) {
            // æå–ç‰¹å¾å‘é‡
            const features = [
                dataPacket.knee_angle,
                dataPacket.resistance_force,
                dataPacket.gait_symmetry,
                dataPacket.movement_smoothness
            ];
            
            const sample = {
                timestamp: new Date().toISOString(),
                features: features,
                exercise_type: dataPacket.exercise_type,
                rehab_stage: dataPacket.rehab_stage,
                raw_data: dataPacket
            };
            
            robotDataBuffer.push(sample);
            collectedSamples++;
            
            // æ›´æ–°è®¡æ•°å™¨
            updateSamplesCounter();
            
            // å¦‚æœè¾¾åˆ°ç›®æ ‡æ ·æœ¬æ•°ï¼Œè‡ªåŠ¨åœæ­¢
            if (collectedSamples >= targetSamples) {
                stopCollection();
                showTemporaryMessage(`å·²æˆåŠŸé‡‡é›† ${targetSamples} ä¸ª ${getActionName(currentAction)} æ ·æœ¬ï¼`, 'success');
            }
        }

        // ========== UI æ›´æ–°å‡½æ•° ==========
        function updateRealTimeDisplay(data) {
            // æ›´æ–°ä»ªè¡¨ç›˜
            document.getElementById('kneeAngle').textContent = `${data.knee_angle}Â°`;
            document.getElementById('resistanceForce').textContent = `${data.resistance_force} N`;
            document.getElementById('gaitSymmetry').textContent = `${data.gait_symmetry}%`;
            document.getElementById('movementSmoothness').textContent = `${data.movement_smoothness}%`;
            
            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById('kneeAngleBar').style.width = `${(data.knee_angle / 120) * 100}%`;
            document.getElementById('resistanceForceBar').style.width = `${(data.resistance_force / 50) * 100}%`;
            document.getElementById('gaitSymmetryBar').style.width = `${data.gait_symmetry}%`;
            document.getElementById('movementSmoothnessBar').style.width = `${data.movement_smoothness}%`;
            
            // æ›´æ–°æ•°æ®è´¨é‡
            const qualityScore = (data.gait_symmetry + data.movement_smoothness) / 2;
            const qualityElement = document.getElementById('dataQuality');
            if (qualityElement) {
                qualityElement.textContent = `${Math.round(qualityScore)}%`;
                if (qualityScore > 85) qualityElement.className = 'text-xl font-bold text-green-400';
                else if (qualityScore > 70) qualityElement.className = 'text-xl font-bold text-yellow-400';
                else qualityElement.className = 'text-xl font-bold text-red-400';
            }
            
            // æ›´æ–°æ•°æ®æµè¡¨æ ¼
            updateDataStreamTable(data);
        }

        function updateDataStreamTable(data) {
            const tbody = document.getElementById('dataStream');
            const newRow = `
                <tr>
                    <td>${data.timestamp}</td>
                    <td>${data.knee_angle}Â°</td>
                    <td>${data.resistance_force} N</td>
                    <td>${data.gait_symmetry}%</td>
                    <td>${data.movement_smoothness}%</td>
                    <td>${data.rehab_stage}</td>
                </tr>
            `;
            
            if (tbody.innerHTML.includes('ç­‰å¾…æ•°æ®é‡‡é›†')) {
                tbody.innerHTML = newRow;
            } else {
                tbody.innerHTML = newRow + tbody.innerHTML;
            }
            
            // é™åˆ¶æ˜¾ç¤ºè¡Œæ•°
            const rows = tbody.getElementsByTagName('tr');
            if (rows.length > 10) {
                tbody.removeChild(rows[rows.length - 1]);
            }
        }

        function updateSamplesCounter() {
            const collectedElement = document.getElementById('collectedSamples');
            const targetElement = document.getElementById('targetSamples');
            const currentActionElement = document.getElementById('currentAction');
            
            if (collectedElement) collectedElement.textContent = collectedSamples;
            if (targetElement) targetElement.textContent = targetSamples;
            if (currentActionElement) currentActionElement.textContent = getActionName(currentAction);
        }

        function getActionName(action) {
            const actions = {
                'knee_flexion_extension': i18n.t('knee_flexion'),
                'hip_abduction_adduction': i18n.t('hip_abduction'),
                'ankle_dorsiflexion': i18n.t('ankle_dorsiflexion'),
                'balance_training': i18n.t('balance_training')
            };
            return actions[action] || i18n.t('not_selected');
        }
        
        // ========== å›¾è¡¨åˆå§‹åŒ–ä¸æ›´æ–° ==========
        function initializeCharts() {
            // è¿åŠ¨å›¾è¡¨ï¼ˆ3Dæ•ˆæœæ¨¡æ‹Ÿï¼‰
            const motionCtx = document.getElementById('motionChart').getContext('2d');
            motionChart = new Chart(motionCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 50}, (_, i) => i),
                    datasets: [
                        {
                            label: 'è†å…³èŠ‚è¿åŠ¨è½¨è¿¹',
                            data: Array(50).fill(60),
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 120,
                            title: {
                                display: true,
                                text: 'è§’åº¦ (Â°)'
                            }
                        }
                    }
                }
            });
        }

        function updateCharts(data) {
            // æ›´æ–°è¿åŠ¨å›¾è¡¨ï¼ˆæ¨¡æ‹Ÿå®æ—¶æ³¢å½¢ï¼‰
            if (motionChart) {
                const time = Date.now() / 1000;
                const newData = Array.from({length: 50}, (_, i) => {
                    return 60 + Math.sin(time + i * 0.2) * 30;
                });
                
                motionChart.data.datasets[0].data = newData;
                motionChart.update('none');
            }
        }

        // ========== æ•°æ®å‘é€ ==========
        async function sendRobotDataToServer() {
            if (!robotDataBuffer || robotDataBuffer.length === 0) {
                showTemporaryMessage(i18n.t('no_data_to_send'), 'error');
                return;
            }
            
            const sendDataBtn = document.getElementById('sendDataBtn');
            const sendDataText = document.getElementById('sendDataText');
            const sendDataLoader = document.getElementById('sendDataLoader');
            
            if (sendDataBtn) sendDataBtn.disabled = true;
            if (sendDataText) sendDataText.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>' + i18n.t('sending');
            if (sendDataLoader) sendDataLoader.classList.remove('hidden');
            
            const samplesToSend = robotDataBuffer.splice(0, robotDataBuffer.length);
            
            try {
                const saveRes = await fetch(API_BASE_URL+'/save_pose_data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: currentAction, 
                        samples: samplesToSend,
                        category: ROBOT_CATEGORY
                    })
                });
                
                if (!saveRes.ok) {
                    throw new Error(`ä¿å­˜å¤±è´¥: ${saveRes.status}`);
                }
                
                const result = await saveRes.json();
                showTemporaryMessage(i18n.t('data_send_success'), 'success');
                
                // è·³è½¬åˆ°è®­ç»ƒé¡µé¢
                setTimeout(() => {
                    window.location.href = `../upper_limb/tranTSF.html?category=${ROBOT_CATEGORY}`;
                }, 1000);
                
            } catch (err) {
                console.error('å‘é€æœºå™¨äººæ ·æœ¬æ—¶å‡ºé”™:', err);
                robotDataBuffer.unshift(...samplesToSend);
                showTemporaryMessage(i18n.t('data_send_failed'), 'error');
            } finally {
                if (sendDataBtn) sendDataBtn.disabled = false;
                if (sendDataText) sendDataText.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>' + i18n.t('send_data');
                if (sendDataLoader) sendDataLoader.classList.add('hidden');
            }
        }

        // ========== åŠ¨ä½œé€‰æ‹© ==========
        function setAction(action, btn) {
            currentAction = action;
            const currentActionElement = document.getElementById('currentAction');
            if (currentActionElement) {
                currentActionElement.textContent = getActionName(currentAction);
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.grid button').forEach(btn => {
                btn.classList.remove('bg-accent');
                btn.classList.add('bg-white/10');
            });
            if (btn && btn.classList) {
                btn.classList.remove('bg-white/10');
                btn.classList.add('bg-accent');
            }
            
            // æ˜¾ç¤ºå¯¹åº”çš„GIF
            showActionGif(action);
            
            if (!isCollecting) {
                showTemporaryMessage(i18n.t('action_selected', {action: getActionName(action)}), 'info');
            }
        }

        // ========== å·¥å…·å‡½æ•° ==========
        function showTemporaryMessage(message, type = 'info') {
            const existingMessages = document.querySelectorAll('.temp-message');
            existingMessages.forEach(msg => msg.remove());
            
            const messageElement = document.createElement('div');
            messageElement.className = `temp-message ${type}`;
            messageElement.textContent = message;
            document.body.appendChild(messageElement);
            
            setTimeout(() => {
                if (messageElement.parentNode) {
                    messageElement.parentNode.removeChild(messageElement);
                }
            }, 3000);
        }

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('åº·å¤æœºå™¨äººæ•°æ®é‡‡é›†é¡µé¢åŠ è½½å®Œæˆ');
            
            // åˆå§‹åŒ–å›½é™…åŒ–
            await i18n.init();
            
            // æ·»åŠ è¯­è¨€åˆ‡æ¢äº‹ä»¶
            document.getElementById('languageSwitch').addEventListener('click', switchLanguage);
            
            // è®¾ç½®é»˜è®¤åŠ¨ä½œ
            setAction('knee_flexion_extension', document.getElementById('kneeFlexionBtn'));
            
            // åˆå§‹åŒ–æ ·æœ¬è®¡æ•°å™¨
            updateSamplesCounter();
        });

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('å…¨å±€é”™è¯¯:', e.error);
            showTemporaryMessage('ç³»ç»Ÿå‘ç”Ÿé”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'error');
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', e.reason);
            showTemporaryMessage('ç³»ç»Ÿå‘ç”Ÿé”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°', 'error');
        });
    </script>
</body>
</html>